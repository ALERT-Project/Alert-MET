<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MET Call Fast Entry</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --red: #cf6679;
            --input-bg: #2d2d2d;
            --border: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
        }

        h1 { margin-top: 0; color: var(--primary); text-align: center; font-size: 1.8rem; }
        .subtitle { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 24px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #aaa; }
        
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 14px;
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            box-sizing: border-box; 
            -webkit-appearance: none; 
        }
        
        select:focus, input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Radio Button Group */
        .radio-group { display: flex; gap: 10px; }
        .radio-option {
            flex: 1;
            position: relative;
        }
        .radio-option input { opacity: 0; position: absolute; width: 0; height: 0; }
        .radio-option label {
            display: block;
            background-color: var(--input-bg);
            padding: 14px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border);
            margin: 0;
            color: #888;
        }
        .radio-option input:checked + label {
            background-color: var(--primary);
            color: #000;
            border-color: var(--primary);
            font-weight: bold;
        }

        .btn-launch {
            width: 100%;
            padding: 18px;
            background-color: var(--red);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(207, 102, 121, 0.3);
            transition: transform 0.1s;
        }
        .btn-launch:active { transform: scale(0.98); }

        .info-box {
            margin-top: 20px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #888;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>MET Call Fast Entry</h1>
    <div class="subtitle">Quick-launch REDCap for MET Calls</div>

    <div class="form-group">
        <label>Role</label>
        <div class="radio-group">
            <div class="radio-option">
                <input type="radio" name="role" id="role_cns" value="1" checked>
                <label for="role_cns">CNS</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="role" id="role_cn" value="2">
                <label for="role_cn">CN</label>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label for="ward">Ward</label>
        <select id="ward">
            <option value="" disabled selected>Select Location...</option>
        </select>
    </div>

    <div class="form-group">
        <label for="adds">ADDS Score</label>
        <input type="number" id="adds" placeholder="Enter score...">
    </div>

    <div class="form-group">
        <label>Outcome</label>
        <select id="outcome">
            <option value="3" selected>Ward Level Care (Keep on Ward)</option>
            <option value="2">ICU Admission</option>
            <option value="4">Palliative / NFR</option>
            <option value="1">Discharge from List</option>
        </select>
    </div>

    <button class="btn-launch" onclick="launchRedcap()">OPEN REDCAP</button>

    <div class="info-box" id="time-preview">
        Auto-Calculated: <span id="auto-time">--</span>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const FIELD_MAP = {
        site: "1",             // Fiona Stanley
        contact_reason: "1",   // MET Call
        
        // "Always Used" Interventions (Checked by default based on your list)
        interventions: {
            "int_group_a___6": "1",  // Attended MET activation
            "int_group_a___8": "1",  // Perform A-E Assessment
            "int_group_a___9": "1",  // Perform Obs
            "int_group_a___10": "1", // 12 Lead ECG
            
            "int_group_b___11": "1", // Chest Auscultations
            "int_group_b___19": "1", // Cognitive assessment
            
            "int_group_c___25": "1", // Abnormal electrolytes/bloods
            
            "met_call_hoot": "1"     // Hoot/MET call YES
        }
    };

    const WARD_MAP = {
        "3A": "1", "3B": "2", "3D": "3", "3C": "5",
        "4A": "6", "4B": "7", "4C": "8", "4D": "9",
        "5A": "10", "5B": "11", "5C": "12", "5D": "13",
        "6A": "14", "6B": "15", "6C": "16", "6D": "17",
        "7A": "18", "7B": "19", "7C": "20", "7D": "21",
        "CCU": "30", "ED": "36", "HDU": "41", 
        "ICU Pod 1": "43", "ICU Pod 2": "43", "ICU Pod 3": "43", "ICU Pod 4": "43",
        "Short Stay": "57", "SRS1A": "58", "SRS2A": "59", "SRSA": "60", "SRSB": "61",
        "Transit Lounge": "64"
    };

    // --- POPULATE WARDS ---
    const wardSelect = document.getElementById('ward');
    Object.keys(WARD_MAP).sort().forEach(w => {
        const opt = document.createElement('option');
        opt.value = WARD_MAP[w];
        opt.textContent = w;
        wardSelect.appendChild(opt);
    });

    // --- TIME & SHIFT LOGIC ---
    function getShiftInfo() {
        const now = new Date();
        
        // Date: YYYY-MM-DD
        const day = ("0" + now.getDate()).slice(-2);
        const month = ("0" + (now.getMonth() + 1)).slice(-2);
        const year = now.getFullYear();
        const dateStr = `${year}-${month}-${day}`;

        // Shift: 07:30 - 14:30 - 20:00
        const decTime = now.getHours() + (now.getMinutes() / 60);
        let shift = "3"; // Default Night
        let shiftName = "Night";

        if (decTime >= 7.5 && decTime < 14.5) {
            shift = "1"; shiftName = "Day";
        } else if (decTime >= 14.5 && decTime < 20.0) {
            shift = "2"; shiftName = "Evening";
        }

        return { date: dateStr, shiftCode: shift, shiftName: shiftName };
    }

    // --- LIVE PREVIEW ---
    function updatePreview() {
        const info = getShiftInfo();
        document.getElementById('auto-time').textContent = `${info.date} | ${info.shiftName} Shift`;
    }
    setInterval(updatePreview, 60000); // Update every min
    updatePreview(); 

    // --- LAUNCHER ---
    function launchRedcap() {
        // 1. Get Inputs
        const role = document.querySelector('input[name="role"]:checked').value;
        const location = document.getElementById('ward').value;
        const addsScore = document.getElementById('adds').value;
        const outcome = document.getElementById('outcome').value;
        const timeInfo = getShiftInfo();

        if (!location) {
            alert("Please select a Ward first.");
            return;
        }

        // 2. Build Params
        let params = [];
        
        // Standard Fields
        params.push(`site=${FIELD_MAP.site}`);
        params.push(`contactreason=${FIELD_MAP.contact_reason}`);
        params.push(`alert_team=${role}`);
        params.push(`location_fs=${location}`);
        params.push(`adds_score=${addsScore}`);
        params.push(`outcome=${outcome}`);
        
        // Date & Shift
        params.push(`shift_date=${timeInfo.date}`);
        params.push(`shifttype=${timeInfo.shiftCode}`);

        // Default Interventions (Loop through config)
        for (const [key, val] of Object.entries(FIELD_MAP.interventions)) {
            params.push(`${key}=${val}`);
        }

        // Outcome Logic (Auto-check intervention for follow up)
        if (outcome === "1") { 
            // Discharge
            params.push("int_group_e___42=1"); 
        } else if (outcome === "3") {
            // Ward Care (Continue Follow up)
            params.push("int_group_e___41=1");
        }

        // 3. Open URL
        const baseUrl = "https://datalibrary-rc.health.wa.gov.au/surveys/?s=K3WAPC4KKXWNTF3F";
        const finalUrl = `${baseUrl}&${params.join('&')}`;
        
        window.open(finalUrl, '_blank');
    }
</script>

</body>
</html>
